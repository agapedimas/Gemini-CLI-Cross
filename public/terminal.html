<ad-title>Terminal</ad-title>

<style>
    .terminal
    {
        display: grid;
        gap: 1em;
    }

    .terminal *
    {
        user-select: text;
        font-family: "Cascadia Mono", monospace, system-ui;
    }

        .terminal .command
        {
            position: relative;
            display: grid;
            grid-template-areas: 
                "username command"
                "x output"
            ;
            grid-auto-columns: max-content auto;
            gap: 10px;
            white-space: pre-wrap;
        }

        .terminal .command:has(.progressring):not(:has(.progressring.hidden))
        {
            grid-template-areas: 
                "username command progressring"
                "x output output"
            ;
            grid-auto-columns: max-content minmax(0, max-content)  20px;
        }
            .terminal .command:before
            {
                grid-area: username;
                content: '>';
                color: var(--foreground-description);
            }
                .terminal .command textarea,
                .terminal .command .inserted
                {
                    grid-area: command;
                    field-sizing: content;
                }
                .terminal .command .output
                {
                    grid-area: output;
                }
                .terminal .command .progressring
                {
                    grid-area: progressring;
                    width: 20px;
                    height: 20px;
                }
</style>

<div class="header">
    <div class="title">Terminal</div>
</div>
<div class="content">
    <div class="terminal">
        <div class="command">
            <textarea id="Input_Command" class="plain"></textarea>
            <div id="Loading_Command" class="progressring hidden"></div>
        </div>
    </div>
</div>

<script>
    let ws; // Variabel buat WebSocket
    let last_command;
    let last_path;

    Input_Command.focus();
    Input_Command.onkeydown = function(e)
    {
        if (e.keyCode == 13)
        {
            e.preventDefault();

            const val = Input_Command.value.trim();

            if (val == "cls")
            {
                $(".terminal .command:not(:has(textarea))").remove();
                Input_Command.value = "";
                Input_Command.focus();
                return;
            }

            Loading_Command.classList.remove("hidden");
            Input_Command.disabled = true;

            if (val && ws && ws.readyState === WebSocket.OPEN) 
            {
                last_command = val;
                ws.send(val);
            }
        }
    }
    
    const connectButton = document.getElementById('connectButton');
    const disconnectButton = document.getElementById('disconnectButton');
    const statusDiv = document.getElementById('status');
    const outputDiv = document.getElementById('output');

    function appendOutput(message, type = "output") 
    {
        const output = document.createElement("span");
        output.classList.add("output");
        output.append(message || "");
        
        const inserted = document.createElement("span");
        inserted.classList.add("inserted");
        inserted.append(last_command || "");
        last_command = null;

        const command = document.createElement("div");
        command.classList.add("command");
        command.setAttribute("path", last_path || ">");
        Input_Command.parentNode.setAttribute("path", last_path || "");
        
        if (type == "output")
            command.append(inserted);
        command.append(output);

        $(".terminal").append(command);
        $(".terminal").append(Input_Command.parentNode);

        Loading_Command.classList.add("hidden");
        Input_Command.disabled = false;
        Input_Command.value = "";
        Input_Command.focus();
    }

    ws = new WebSocket('ws://localhost:3000');

    ws.onopen = () => {
    };

    ws.onmessage = event => {
        if (message.trim() != "")
            appendOutput(message);
    };

    ws.onerror = error => {
        appendOutput('Terjadi error pada koneksi WebSocket.', "event");
    };

    ws.onclose = () => {
        appendOutput('Koneksi WebSocket terputus.', "event");
        Input_Command.disabled = true;
    };
</script>